<div class="page-container">
  <header class="page-header">
    <h1>Sistema de Ligas Barriales</h1>
    <div class="user-info" *ngIf="user$ | async as user">
      <span>{{ user.nombre }}</span>
      <span class="user-role">({{ user.rol.nombre }})</span>
      <button class="btn-logout" (click)="logout()">Cerrar SesiÃ³n</button>
    </div>
  </header>

  <app-main-nav></app-main-nav>

  <div class="jugador-campeonatos-container">
    <div class="header">
      <h2>HabilitaciÃ³n de Jugadores</h2>
      <div class="header-actions">
        <button *ngIf="canApprove()" class="btn-warning" routerLink="/jugador-campeonatos/pendientes">
          â³ Ver Solo Pendientes
        </button>
        <button *ngIf="canCreate()" class="btn-primary" routerLink="/jugador-campeonatos/habilitar">
          <span class="icon">+</span> Habilitar Jugadores
        </button>
      </div>
    </div>

    <div class="info-panel info-help">
      <strong>â„¹ï¸ InformaciÃ³n importante sobre rechazos:</strong> 
      <br>â€¢ Las habilitaciones rechazadas se muestran con borde rojo y el motivo del rechazo.
      <br>â€¢ Puede crear una nueva solicitud para el mismo jugador usando el botÃ³n "Habilitar Jugadores".
      <br>â€¢ Use el botÃ³n ğŸ“‹ para ver el historial completo de habilitaciones de un jugador.
    </div>

    <!-- Filtros -->
    <div class="filters-container" *ngIf="canShowFilters() && !loading && jugadorCampeonatos.length > 0">
      <div class="filters-header">
        <h3>ğŸ” Filtros</h3>
        <button class="btn-clear-filters" (click)="clearFilters()" *ngIf="filterLigaId || filterCampeonatoId || filterEquipoId || filterEstado || searchTerm">
          Limpiar filtros
        </button>
      </div>
      
      <div class="filters-grid">
        <!-- Filtro por Liga (solo master) -->
        <div class="filter-group" *ngIf="canShowLigaFilter()">
          <label for="filterLiga">Liga</label>
          <select id="filterLiga" [(ngModel)]="filterLigaId" (change)="onLigaChange()">
            <option value="">Todas las ligas</option>
            <option *ngFor="let liga of ligas" [value]="liga.id">{{ liga.nombre }}</option>
          </select>
        </div>

        <!-- Filtro por Campeonato -->
        <div class="filter-group" *ngIf="canShowCampeonatoFilter()">
          <label for="filterCampeonato">Campeonato</label>
          <select id="filterCampeonato" [(ngModel)]="filterCampeonatoId" (change)="applyFilters()">
            <option value="">Todos los campeonatos</option>
            <option *ngFor="let campeonato of filteredCampeonatos" [value]="campeonato.id">{{ campeonato.nombre }}</option>
          </select>
        </div>

        <!-- Filtro por Equipo -->
        <div class="filter-group" *ngIf="canShowEquipoFilter()">
          <label for="filterEquipo">Equipo</label>
          <select id="filterEquipo" [(ngModel)]="filterEquipoId" (change)="applyFilters()">
            <option value="">Todos los equipos</option>
            <option *ngFor="let equipo of filteredEquipos" [value]="equipo.id">{{ equipo.nombre }}</option>
          </select>
        </div>

        <!-- Filtro por Estado -->
        <div class="filter-group">
          <label for="filterEstado">Estado</label>
          <select id="filterEstado" [(ngModel)]="filterEstado" (change)="applyFilters()">
            <option value="">Todos los estados</option>
            <option value="pendiente">Pendiente</option>
            <option value="habilitado">Habilitado</option>
            <option value="rechazado">Rechazado</option>
          </select>
        </div>
      </div>

      <div class="filter-results" *ngIf="filterLigaId || filterCampeonatoId || filterEquipoId || filterEstado">
        <span>ğŸ“Š Mostrando {{ filteredJugadorCampeonatos.length }} de {{ jugadorCampeonatos.length }} habilitaciones</span>
      </div>

      <!-- BotÃ³n para generar carnets por equipo -->
      <div class="carnets-por-equipo-container" *ngIf="showCarnetsPorEquipoButton()">
        <button class="btn-carnets-equipo" (click)="generarCarnetsPorEquipo()" title="Generar carnets de todos los jugadores habilitados del equipo">
          ğŸªª Generar Carnets del Equipo
        </button>
      </div>
    </div>

    <!-- Barra de bÃºsqueda -->
    <div class="search-container" *ngIf="!loading && jugadorCampeonatos.length > 0">
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Buscar por nombre o cÃ©dula del jugador..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange($any($event.target).value)"
        />
        <button 
          *ngIf="searchTerm" 
          class="clear-btn" 
          (click)="clearSearch()"
          title="Limpiar bÃºsqueda">
          âœ•
        </button>
      </div>
      <div class="search-results" *ngIf="searchTerm || filterLigaId || filterCampeonatoId || filterEquipoId || filterEstado">
        <span>{{ filteredJugadorCampeonatos.length }} de {{ jugadorCampeonatos.length }} habilitaciones</span>
      </div>
    </div>

    <div *ngIf="loading" class="loading">
      Cargando habilitaciones...
    </div>

    <div *ngIf="errorMessage" class="error-message">
      {{ errorMessage }}
    </div>

    <div *ngIf="!loading && jugadorCampeonatos.length === 0" class="empty-state">
      <p>No hay jugadores habilitados</p>
      <button *ngIf="canCreate()" class="btn-primary" routerLink="/jugador-campeonatos/habilitar">
        <span class="icon">+</span> Habilitar Primer Jugador
      </button>
    </div>

    <div *ngIf="!loading && jugadorCampeonatos.length > 0" class="jugador-campeonatos-grid">
      <div *ngFor="let jc of filteredJugadorCampeonatos" class="jugador-campeonato-card" 
           [class.habilitado]="jc.estado === 'habilitado'"
           [class.pendiente]="jc.estado === 'pendiente'"
           [class.rechazado]="jc.estado === 'rechazado'"
           [class.inactive]="!jc.activo">
        
        <div class="card-header">
          <div class="jugador-info">
            <div class="jugador-nombre-container">
              <h3>{{ jc.jugador?.nombre || 'Jugador' }}</h3>
              <span class="numero-posicion">#{{ jc.numeroCancha }} - {{ jc.posicion }}</span>
            </div>
          </div>
          <div class="badges">
            <span class="status-badge" 
                  [class.status-habilitado]="jc.estado === 'habilitado'"
                  [class.status-pending]="jc.estado === 'pendiente'"
                  [class.status-rejected]="jc.estado === 'rechazado'">
              {{ getEstadoText(jc.estado) }}
            </span>
            <span *ngIf="!jc.activo" class="status-badge status-inactive">
              Inactivo
            </span>
          </div>
        </div>

        <!-- SecciÃ³n de imÃ¡genes -->
        <div class="images-section">
          <div class="image-container">
            <label class="image-label">Foto del Jugador</label>
            <img
              *ngIf="jc.jugador?.imagen"
              [src]="jc.jugador.imagen"
              alt="Foto de {{ jc.jugador.nombre }}"
              class="player-image"
            />
            <div class="player-photo-placeholder" *ngIf="!jc.jugador?.imagen">
              ğŸ‘¤
            </div>
          </div>
          <div class="image-container">
            <label class="image-label">CÃ©dula</label>
            <img
              *ngIf="jc.jugador?.imagenCedula"
              [src]="jc.jugador.imagenCedula"
              alt="CÃ©dula de {{ jc.jugador.nombre }}"
              class="cedula-image"
              (click)="openImageModal(jc.jugador.imagenCedula)"
            />
            <div class="cedula-placeholder" *ngIf="!jc.jugador?.imagenCedula">
              ğŸ“„
            </div>
          </div>
        </div>
        
        <div class="card-body">
          <p><strong>Equipo:</strong> {{ jc.equipo?.nombre || 'N/A' }}</p>
          <p><strong>CategorÃ­a:</strong> {{ jc.categoria?.nombre || 'N/A' }}</p>
          <p><strong>CÃ©dula:</strong> {{ jc.jugador?.cedula || 'N/A' }}</p>
          <p><strong>Fecha Solicitud:</strong> {{ jc.fechaInscripcion | date:'dd/MM/yyyy HH:mm' }}</p>
          <p *ngIf="jc.fechaAprobacion"><strong>Fecha AprobaciÃ³n:</strong> {{ jc.fechaAprobacion | date:'dd/MM/yyyy HH:mm' }}</p>
          
          <!-- Mensaje especial para habilitaciones rechazadas -->
          <div *ngIf="jc.estado === 'rechazado' && !jc.activo" class="rechazo-info">
            <p class="rechazo-title"><strong>âš ï¸ SOLICITUD RECHAZADA</strong></p>
            <p *ngIf="jc.observaciones" class="observaciones-rechazo">
              <strong>Motivo del rechazo:</strong><br>
              {{ jc.observaciones }}
            </p>
            <p class="rechazo-accion">
              ğŸ’¡ Puede crear una nueva solicitud corrigiendo los detalles mencionados usando el botÃ³n "Habilitar Jugadores" en la parte superior.
            </p>
          </div>
          
          <!-- Observaciones normales para otros estados -->
          <p *ngIf="jc.observaciones && (jc.estado !== 'rechazado' || jc.activo)" class="observaciones">
            <strong>Observaciones:</strong> {{ jc.observaciones }}
          </p>
        </div>

        <div class="card-actions">
          <button *ngIf="canApprove() && jc.estado === 'pendiente'" 
                  class="btn-icon success" 
                  (click)="aprobar(jc.id)" 
                  title="Aprobar HabilitaciÃ³n">
            âœ…
          </button>
          <button *ngIf="canApprove() && jc.estado === 'pendiente'" 
                  class="btn-icon danger" 
                  (click)="rechazar(jc.id)" 
                  title="Rechazar HabilitaciÃ³n">
            âŒ
          </button>
          <button *ngIf="canGenerarCarnet(jc)" 
                  class="btn-icon carnet" 
                  (click)="descargarCarnet(jc)" 
                  title="Descargar Carnet">
            ğŸªª
          </button>
          <button class="btn-icon" 
                  (click)="verHistorial(jc.jugadorId)" 
                  title="Ver Historial">
            ğŸ“‹
          </button>
          <button *ngIf="canEdit() && jc.estado === 'pendiente'" 
                  class="btn-icon" 
                  (click)="editar(jc.id)" 
                  title="Editar">
            âœï¸
          </button>
        </div>
      </div>
    </div>

    <!-- Modal para ampliar imagen de cÃ©dula -->
    <div class="modal-overlay" *ngIf="showImageModal" (click)="closeImageModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="closeImageModal()">âœ•</button>
        <img [src]="modalImageUrl" alt="CÃ©dula ampliada" class="modal-image">
      </div>
    </div>
  </div>
</div>
