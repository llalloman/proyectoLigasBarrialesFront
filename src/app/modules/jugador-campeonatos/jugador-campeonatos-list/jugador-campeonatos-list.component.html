<div class="page-container">
  <header class="page-header">
    <h1>Sistema de Ligas Barriales</h1>
    <div class="user-info" *ngIf="user$ | async as user">
      <span>{{ user.nombre }}</span>
      <span class="user-role">({{ user.rol.nombre }})</span>
      <button class="btn-logout" (click)="logout()">Cerrar Sesi√≥n</button>
    </div>
  </header>

  <app-main-nav></app-main-nav>

  <div class="jugador-campeonatos-container">
    <div class="header">
      <h2>Habilitaci√≥n de Jugadores</h2>
      <div class="header-actions">
        <button *ngIf="canApprove()" class="btn-warning" routerLink="/jugador-campeonatos/pendientes">
          ‚è≥ Ver Solo Pendientes
        </button>
        <button *ngIf="canCreate()" class="btn-primary" routerLink="/jugador-campeonatos/habilitar" [queryParams]="{campeonatoId: campeonatoId}">
          <span class="icon">+</span> Habilitar Jugadores
        </button>
      </div>
    </div>

    <div *ngIf="campeonatoNombre" class="info-panel">
      <div class="info-item">
        <strong>Campeonato:</strong> {{ campeonatoNombre }}
      </div>
      <button class="btn-secondary" routerLink="/campeonatos">‚Üê Volver a Campeonatos</button>
    </div>

    <div class="info-panel info-help">
      <strong>‚ÑπÔ∏è Informaci√≥n importante sobre rechazos:</strong> 
      <br>‚Ä¢ Las habilitaciones rechazadas se muestran con borde rojo y el motivo del rechazo.
      <br>‚Ä¢ Puede crear una nueva solicitud para el mismo jugador usando el bot√≥n "Habilitar Jugadores".
      <br>‚Ä¢ Use el bot√≥n üìã para ver el historial completo de habilitaciones de un jugador.
    </div>

    <!-- Barra de b√∫squeda -->
    <div class="search-container" *ngIf="!loading && jugadorCampeonatos.length > 0">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Buscar por nombre o c√©dula del jugador..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange($any($event.target).value)"
        />
        <button 
          *ngIf="searchTerm" 
          class="clear-btn" 
          (click)="clearSearch()"
          title="Limpiar b√∫squeda">
          ‚úï
        </button>
      </div>
      <div class="search-results" *ngIf="searchTerm">
        <span>{{ filteredJugadorCampeonatos.length }} de {{ jugadorCampeonatos.length }} habilitaciones</span>
      </div>
    </div>

    <div *ngIf="loading" class="loading">
      Cargando habilitaciones...
    </div>

    <div *ngIf="errorMessage" class="error-message">
      {{ errorMessage }}
    </div>

    <div *ngIf="!loading && jugadorCampeonatos.length === 0" class="empty-state">
      <p>No hay jugadores habilitados</p>
      <button *ngIf="canCreate()" class="btn-primary" routerLink="/jugador-campeonatos/habilitar" [queryParams]="{campeonatoId: campeonatoId}">
        <span class="icon">+</span> Habilitar Primer Jugador
      </button>
    </div>

    <div *ngIf="!loading && jugadorCampeonatos.length > 0" class="jugador-campeonatos-grid">
      <div *ngFor="let jc of filteredJugadorCampeonatos" class="jugador-campeonato-card" 
           [class.habilitado]="jc.estado === 'habilitado'"
           [class.pendiente]="jc.estado === 'pendiente'"
           [class.rechazado]="jc.estado === 'rechazado'"
           [class.inactive]="!jc.activo">
        
        <div class="card-header">
          <div class="jugador-info">
            <div class="jugador-nombre-container">
              <h3>{{ jc.jugador?.nombre || 'Jugador' }}</h3>
              <span class="numero-posicion">#{{ jc.numeroCancha }} - {{ jc.posicion }}</span>
            </div>
          </div>
          <div class="badges">
            <span class="status-badge" 
                  [class.status-habilitado]="jc.estado === 'habilitado'"
                  [class.status-pending]="jc.estado === 'pendiente'"
                  [class.status-rejected]="jc.estado === 'rechazado'">
              {{ getEstadoText(jc.estado) }}
            </span>
            <span *ngIf="!jc.activo" class="status-badge status-inactive">
              Inactivo
            </span>
          </div>
        </div>

        <!-- Secci√≥n de im√°genes -->
        <div class="images-section">
          <div class="image-container">
            <label class="image-label">Foto del Jugador</label>
            <img
              *ngIf="jc.jugador?.imagen"
              [src]="jc.jugador.imagen"
              alt="Foto de {{ jc.jugador.nombre }}"
              class="player-image"
            />
            <div class="player-photo-placeholder" *ngIf="!jc.jugador?.imagen">
              üë§
            </div>
          </div>
          <div class="image-container">
            <label class="image-label">C√©dula</label>
            <img
              *ngIf="jc.jugador?.imagenCedula"
              [src]="jc.jugador.imagenCedula"
              alt="C√©dula de {{ jc.jugador.nombre }}"
              class="cedula-image"
              (click)="openImageModal(jc.jugador.imagenCedula)"
            />
            <div class="cedula-placeholder" *ngIf="!jc.jugador?.imagenCedula">
              üìÑ
            </div>
          </div>
        </div>
        
        <div class="card-body">
          <p><strong>Equipo:</strong> {{ jc.equipo?.nombre || 'N/A' }}</p>
          <p><strong>Categor√≠a:</strong> {{ jc.categoria?.nombre || 'N/A' }}</p>
          <p><strong>C√©dula:</strong> {{ jc.jugador?.cedula || 'N/A' }}</p>
          <p><strong>Fecha Solicitud:</strong> {{ jc.fechaInscripcion | date:'dd/MM/yyyy HH:mm' }}</p>
          <p *ngIf="jc.fechaAprobacion"><strong>Fecha Aprobaci√≥n:</strong> {{ jc.fechaAprobacion | date:'dd/MM/yyyy HH:mm' }}</p>
          
          <!-- Mensaje especial para habilitaciones rechazadas -->
          <div *ngIf="jc.estado === 'rechazado' && !jc.activo" class="rechazo-info">
            <p class="rechazo-title"><strong>‚ö†Ô∏è SOLICITUD RECHAZADA</strong></p>
            <p *ngIf="jc.observaciones" class="observaciones-rechazo">
              <strong>Motivo del rechazo:</strong><br>
              {{ jc.observaciones }}
            </p>
            <p class="rechazo-accion">
              üí° Puede crear una nueva solicitud corrigiendo los detalles mencionados usando el bot√≥n "Habilitar Jugadores" en la parte superior.
            </p>
          </div>
          
          <!-- Observaciones normales para otros estados -->
          <p *ngIf="jc.observaciones && (jc.estado !== 'rechazado' || jc.activo)" class="observaciones">
            <strong>Observaciones:</strong> {{ jc.observaciones }}
          </p>
        </div>

        <div class="card-actions">
          <button *ngIf="canApprove() && jc.estado === 'pendiente'" 
                  class="btn-icon success" 
                  (click)="aprobar(jc.id)" 
                  title="Aprobar Habilitaci√≥n">
            ‚úÖ
          </button>
          <button *ngIf="canApprove() && jc.estado === 'pendiente'" 
                  class="btn-icon danger" 
                  (click)="rechazar(jc.id)" 
                  title="Rechazar Habilitaci√≥n">
            ‚ùå
          </button>
          <button class="btn-icon" 
                  (click)="verHistorial(jc.jugadorId)" 
                  title="Ver Historial">
            üìã
          </button>
          <button *ngIf="canEdit() && jc.estado === 'pendiente'" 
                  class="btn-icon" 
                  (click)="editar(jc.id)" 
                  title="Editar">
            ‚úèÔ∏è
          </button>
        </div>
      </div>
    </div>

    <!-- Modal para ampliar imagen de c√©dula -->
    <div class="modal-overlay" *ngIf="showImageModal" (click)="closeImageModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="closeImageModal()">‚úï</button>
        <img [src]="modalImageUrl" alt="C√©dula ampliada" class="modal-image">
      </div>
    </div>
  </div>
</div>
