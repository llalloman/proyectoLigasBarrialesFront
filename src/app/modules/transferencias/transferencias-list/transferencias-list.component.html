<div class="page-container">
  <header class="page-header">
    <h1>Sistema de Ligas Barriales</h1>
    <div class="user-info" *ngIf="user$ | async as user">
      <span>{{ user.nombre }}</span>
      <span class="user-role">({{ user.rol.nombre }})</span>
      <button class="btn-logout" (click)="logout()">Cerrar SesiÃ³n</button>
    </div>
  </header>

  <app-main-nav></app-main-nav>

  <div class="page-title">
    <h2>ğŸ”„ Transferencias</h2>
    <div class="header-actions">
      <button
        type="button"
        class="btn btn-secondary"
        routerLink="/transferencias/pendientes-origen"
        *ngIf="permissions.canAprobarTransferenciaEquipoOrigen()"
      >
        â³ Pendientes de Mi Equipo
      </button>
      <button
        type="button"
        class="btn btn-secondary"
        routerLink="/transferencias/pendientes-directivo"
        *ngIf="permissions.canAprobarTransferenciaDirectivo()"
      >
        â³ Pendientes de AprobaciÃ³n
      </button>
      <button
        type="button"
        class="btn btn-primary"
        routerLink="/transferencias/solicitar"
        *ngIf="permissions.canSolicitarTransferencia()"
      >
        + Nueva Solicitud
      </button>
    </div>
  </div>

  <div class="alert alert-success" *ngIf="successMessage">
    {{ successMessage }}
  </div>

  <div class="alert alert-error" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <!-- SecciÃ³n de Filtros -->
  <div class="filters-section" *ngIf="canShowFilters() && !loading">
    <div class="filters-header">
      <h3>ğŸ” Filtros de BÃºsqueda</h3>
      <button type="button" class="btn-clear-filters" (click)="clearFilters()">
        ğŸ—‘ï¸ Limpiar Filtros
      </button>
    </div>

    <div class="filters-grid">
      <!-- Liga (solo para master y directivo_liga) -->
      <div class="filter-item" *ngIf="permissions.isMaster() || permissions.isDirectivo()">
        <label for="filter-liga">Liga</label>
        <select 
          id="filter-liga" 
          [(ngModel)]="selectedLigaId" 
          (change)="onLigaChange()"
          class="filter-select"
        >
          <option [ngValue]="null">Todas las ligas</option>
          <option *ngFor="let liga of ligas" [ngValue]="liga.id">
            {{ liga.nombre }}
          </option>
        </select>
      </div>

      <!-- Campeonato -->
      <div class="filter-item">
        <label for="filter-campeonato">Campeonato</label>
        <select 
          id="filter-campeonato" 
          [(ngModel)]="selectedCampeonatoId"
          (change)="onCampeonatoChange()"
          class="filter-select"
        >
          <option [ngValue]="null">Todos los campeonatos</option>
          <option *ngFor="let campeonato of filteredCampeonatos" [ngValue]="campeonato.id">
            {{ campeonato.nombre }}
          </option>
        </select>
      </div>

      <!-- Equipo Origen (solo master y directivo_liga) -->
      <div class="filter-item" *ngIf="permissions.isMaster() || permissions.isDirectivo()">
        <label for="filter-equipo-origen">Equipo Origen</label>
        <select 
          id="filter-equipo-origen" 
          [(ngModel)]="selectedEquipoOrigenId"
          class="filter-select"
        >
          <option [ngValue]="null">Todos los equipos</option>
          <option *ngFor="let equipo of filteredEquiposOrigen" [ngValue]="equipo.id">
            {{ equipo.nombre }}
          </option>
        </select>
      </div>

      <!-- Equipo Destino (solo master y directivo_liga) -->
      <div class="filter-item" *ngIf="permissions.isMaster() || permissions.isDirectivo()">
        <label for="filter-equipo-destino">Equipo Destino</label>
        <select 
          id="filter-equipo-destino" 
          [(ngModel)]="selectedEquipoDestinoId"
          class="filter-select"
        >
          <option [ngValue]="null">Todos los equipos</option>
          <option *ngFor="let equipo of filteredEquiposDestino" [ngValue]="equipo.id">
            {{ equipo.nombre }}
          </option>
        </select>
      </div>

      <!-- Estado -->
      <div class="filter-item">
        <label for="filter-estado">Estado</label>
        <select 
          id="filter-estado" 
          [(ngModel)]="selectedEstado"
          class="filter-select"
        >
          <option *ngFor="let estado of estados" [value]="estado.value">
            {{ estado.label }}
          </option>
        </select>
      </div>

      <!-- Jugador (Autocomplete) -->
      <div class="filter-item filter-item-full">
        <label for="filter-jugador">Jugador</label>
        <mat-form-field class="filter-autocomplete" appearance="outline">
          <mat-label>Buscar por nombre o cÃ©dula...</mat-label>
          <input 
            type="text"
            matInput
            [formControl]="jugadorControl"
            [matAutocomplete]="autoJugador"
          />
          <mat-autocomplete #autoJugador="matAutocomplete" [displayWith]="displayJugador.bind(this)">
            <mat-option *ngFor="let jugador of filteredJugadores$ | async" [value]="jugador">
              {{ jugador.nombreCompleto || jugador.nombre }} ({{ jugador.cedula }})
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>

      <!-- Fecha Desde -->
      <div class="filter-item">
        <label for="filter-fecha-desde">Fecha Desde</label>
        <input 
          type="date" 
          id="filter-fecha-desde" 
          [(ngModel)]="fechaDesde"
          class="filter-input"
        />
      </div>

      <!-- Fecha Hasta -->
      <div class="filter-item">
        <label for="filter-fecha-hasta">Fecha Hasta</label>
        <input 
          type="date" 
          id="filter-fecha-hasta" 
          [(ngModel)]="fechaHasta"
          class="filter-input"
        />
      </div>
    </div>

    <div class="filters-summary" *ngIf="selectedLigaId || selectedCampeonatoId || selectedEquipoOrigenId || selectedEquipoDestinoId || selectedEstado || jugadorControl.value || fechaDesde || fechaHasta">
      <span class="summary-text">
        Mostrando {{ filteredTransferencias.length }} de {{ transferencias.length }} transferencias
      </span>
    </div>
  </div>

  <div class="loading-spinner" *ngIf="loading">
    <p>Cargando...</p>
  </div>

  <div class="empty-state" *ngIf="!loading && transferencias.length === 0">
    <p>No hay transferencias registradas</p>
  </div>

  <div class="empty-state" *ngIf="!loading && transferencias.length > 0 && filteredTransferencias.length === 0">
    <p>No se encontraron transferencias con ese criterio de bÃºsqueda</p>
  </div>

  <div class="cards-grid" *ngIf="!loading && filteredTransferencias.length > 0">
    <div class="card" *ngFor="let transferencia of filteredTransferencias">
      <div class="card-header">
        <div class="player-info">
          <img
            *ngIf="transferencia.jugador?.fotoPerfil || transferencia.jugador?.imagen"
            [src]="transferencia.jugador.fotoPerfil || transferencia.jugador.imagen"
            alt="{{ transferencia.jugador.nombreCompleto || transferencia.jugador.nombre }}"
            class="player-photo"
          />
          <div class="player-photo-placeholder" *ngIf="!transferencia.jugador?.fotoPerfil && !transferencia.jugador?.imagen">
            ğŸ‘¤
          </div>
          <div>
            <h3>{{ transferencia.jugador?.nombreCompleto || transferencia.jugador?.nombre || 'Sin nombre' }}</h3>
            <div class="player-cedula">
              <p class="player-detail">{{ transferencia.jugador?.cedula }}</p>
              <button
                type="button"
                class="btn-view-cedula"
                (click)="viewCedulaImage(transferencia.jugador?.imagenCedula)"
                title="Ver imagen de cÃ©dula"
              >
                ğŸªª
              </button>
            </div>
          </div>
        </div>
        <span
          class="badge"
          [ngClass]="getEstadoCompletoClass(transferencia)"
        >
          {{ getEstadoCompletoText(transferencia) }}
        </span>
      </div>

      <div class="card-body">
        <div class="info-row">
          <span class="label">Campeonato:</span>
          <span class="value">{{ transferencia.campeonato?.nombre }}</span>
        </div>
        <div class="transfer-flow">
          <div class="team-box">
            <span class="team-label">De:</span>
            <span class="team-name">{{ transferencia.equipoOrigen?.nombre }}</span>
          </div>
          <div class="arrow">â†’</div>
          <div class="team-box">
            <span class="team-label">A:</span>
            <span class="team-name">{{ transferencia.equipoDestino?.nombre }}</span>
          </div>
        </div>

        <div class="estados-container">
          <div class="estado-item">
            <span class="estado-label">Equipo Origen:</span>
            <span
              class="badge badge-sm"
              [ngClass]="getEstadoClass(transferencia.estadoEquipoOrigen)"
            >
              {{ transferencia.estadoEquipoOrigen }}
            </span>
          </div>
          <div class="estado-item">
            <span class="estado-label">Directivo:</span>
            <span
              class="badge badge-sm"
              [ngClass]="getEstadoClass(transferencia.estadoDirectivo)"
            >
              {{ transferencia.estadoDirectivo }}
            </span>
          </div>
        </div>

        <div class="info-row" *ngIf="transferencia.observaciones">
          <span class="label">Observaciones:</span>
          <span class="value">{{ transferencia.observaciones }}</span>
        </div>
        <div class="info-row">
          <span class="label">Fecha Solicitud:</span>
          <span class="value">{{
            transferencia.fechaSolicitud | date: 'short'
          }}</span>
        </div>
      </div>

      <div class="card-actions">
        <button
          type="button"
          class="btn-icon btn-success"
          (click)="descargarPdf(transferencia)"
          title="Descargar PDF"
          *ngIf="canDownloadPdf(transferencia) && transferencia.estadoEquipoOrigen !== 'rechazado' && transferencia.estadoDirectivo !== 'rechazado'"
        >
          ğŸ“„
        </button>
        <button
          type="button"
          class="btn-icon btn-danger"
          (click)="cancelar(transferencia.id)"
          title="Cancelar"
          *ngIf="canCancelar(transferencia)"
        >
          âŒ
        </button>
      </div>
    </div>
  </div>
</div>
